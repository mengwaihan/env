server {
    listen 80;
    autoindex on;
    index off;
	server_name ~^cdn\.ebd\.(?P<localdomain>[^\.]+)\.lc;
    access_log off;
    error_page 404 500 502 503 504 /index.html;

    rewrite ^(/upload/banner/\d+/).+\.(\d+.jpg)$ $1$2 last;

    resolver 192.168.0.8;

    # ebdcdn.com/xxx
    location / {
        root /sites/res.ebdcdn.com;
    }

    # static files
    location /static/ {
        # with timestamp
        if ($request_uri ~ \.\d+\.(js|css|jpg|gif|png)$) {
            rewrite ^(.+)\.\d+\.(\w+)$ $1.$2 last;
            expires max;
        }
        
        # fronts
        if ($request_filename ~ '\.woff$') {
            add_header Access-Control-Allow-Origin "*";
            expires max;
        }
        alias /sites/www.eyebuydirect.com/static/;
    }
    
    # original files in upload directory
    location /upload/ {
        alias /sites/www.eyebuydirect.com/res/upload/;
        expires max;
    }
    
    # product images
    location /product/ {
        expires max;
        proxy_pass http://cdn.ebdcdn.ebd.lc.eyebuydirect.com;
    }

    # upload thumbnails
    location ~ ^/(upload/.+)\.(\d+x\d+)\.(jpg|jpeg|png|gif|bmp)$ {
        error_page 404 @empty;
        expires max;
        proxy_pass http://ebd.$localdomain.lc/tools/thumb.php?src=$1.$3&s=$2;
    }
        
    # contact js and css files
    location ~ ^/static/(js|css)/_(\w+),(.+)$ {
        expires max;
        proxy_pass http://ebd.$localdomain.lc/concat.php?files=$3&format=$1&v=$2;
    }

    # ebdcdn.com/watermark
    location /watermark/ {
        expires max;
        proxy_pass http://ebd.$localdomain.lc;
    }

    # deny php files
    location ~ \.php$ {
        deny all;
    }

    # empty picture (for 404)
    location @empty {
        internal;
        empty_gif;
    }
}